<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static '/css/pregunta.css' %}" />
    <title>Pregunta</title>
</head>

{% include "navbar.html" %}

<div>
    <form class="form" action="" method="POST" onsubmit="return saveAns()">
        {% csrf_token %}
        <div class="pregunta-container">
            <p id="pregunta-texto"></p>
        </div>

        <div class="respuestas-container">
            <!-- Campo oculto para almacenar la respuesta seleccionada -->
            <input type="hidden" id="selected_answer" name="selected_answer" value="">

            <!-- Botones de opciones, se generarán dinámicamente desde el script -->
            <div id="respuestas-buttons"></div>
        </div>
    </form>

    <div class="botones-container">
        <button id="siguiente" type="button" onclick="obtenerPregunta()">Siguiente</button>
    </div>

    <!-- Indicador de carga -->
    <div id="loading-indicator" style="display:none;">
        <p>Cargando pregunta...</p>
    </div>
</div>

<script>
    // Función para obtener la siguiente pregunta de la vista chatgpt
    function obtenerPregunta() {
        // Muestra el indicador de carga
        document.getElementById('loading-indicator').style.display = 'block';

        // Oculta el contenido mientras se espera la respuesta
        document.querySelector('.pregunta-container').style.display = 'none';
        document.querySelector('.respuestas-container').style.display = 'none';

        const requestData = {
            materia: "Fisica",  // Ajusta estos valores según la necesidad
            nivel: "4to Medio"
        };

        fetch('/api/chatgpt/', {
            method: 'POST', // Usa POST porque la vista chatgpt espera un POST
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())  // Convierte la respuesta a JSON
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                    return;
                }

                // Oculta el indicador de carga y muestra el contenido
                document.getElementById('loading-indicator').style.display = 'none';
                document.querySelector('.pregunta-container').style.display = 'block';
                document.querySelector('.respuestas-container').style.display = 'block';

                // Actualiza el DOM con la nueva pregunta
                document.getElementById('pregunta-texto').innerText = data.texto_pregunta;

                // Limpia las respuestas anteriores
                const respuestasContainer = document.getElementById('respuestas-buttons');
                respuestasContainer.innerHTML = '';
                console.log(data)

                // Genera los nuevos botones de respuesta
                data.respuestas.forEach((respuesta, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.innerText = respuesta.texto_respuesta;
                    button.onclick = function () {
                        seleccionarRespuesta(respuesta);
                    };
                    respuestasContainer.appendChild(button);
                });
            })
            .catch(error => {
                console.error('Error al obtener la pregunta:', error);
                document.getElementById('loading-indicator').innerText = 'Error al cargar la pregunta. Intenta de nuevo.';
            });
    }

    // Función para seleccionar una respuesta y almacenarla en cookies
    function seleccionarRespuesta(respuesta) {
        document.getElementById('selected_answer').value = respuesta.texto;

        const selectedData = {
            pregunta: document.getElementById('pregunta-texto').innerText,
            selected_answer: respuesta.texto
        };

        setCookie('respuesta_seleccionada', JSON.stringify(selectedData), 3);
    }

    // Función para guardar la cookie
    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    // Llama a obtenerPregunta() para cargar la primera pregunta al cargar la página
    document.addEventListener('DOMContentLoaded', obtenerPregunta);
</script>