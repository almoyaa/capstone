<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Retroalimentación de cuestionario</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/retroalimentacion.css' %}" />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  {% include "navbar.html" %}

  <body>
    <div class="container">
      <h1>Retroalimentación</h1>
      <div class="sub-container">
        <div class="container-info">
          <h2>{{ cuestionario.titulo }}</h2>
          <p><strong>Descripción:</strong> {{ cuestionario.descripcion }}</p>
          <p><strong>Materia:</strong> {{ cuestionario.materia }}</p>
          <p>
            <strong>Preguntas Correctas:</strong>
            {{cuestionario.respuestas_correctas }}
          </p>
          <p><strong>Total de Preguntas:</strong> {{ preguntas|length }}</p>
          <p>
            <strong>Resultado:</strong>
            {{cuestionario.respuestas_correctas}}/{{ preguntas|length }}
          </p>
          <p>
            <strong>Comentario: </strong>
            <p id='comentario-openai'>
              
            </p>
          </p>
        </div>
        <div class="graph-container">
          <canvas id="pie-chart"></canvas>
        </div>
      </div>
      <div>
        <h1>Respuestas del cuestionario</h1>
        <div>
          {% for respuesta_data in respuestas_usuario %}
          <p>
            <strong>
              {{ forloop.counter }}. {{respuesta_data.pregunta.texto_pregunta}}
            </strong>
          </p>

          <p
            class="respuesta {% if respuesta_data.es_correcta %}respuesta-correcta{% else %}respuesta-incorrecta{% endif %}"
          >
            {% if respuesta_data.es_correcta == False %}
            <strong>Tú respuesta: </strong>
            {{ respuesta_data.respuesta_usuario }} {% endif %}
            <br />
            <strong>Respuesta correcta: </strong>
            {{ respuesta_data.respuesta_correcta }}
          </p>
          <hr />
          {% endfor %}
        </div>
      </div>

      <!-- Contenedor de diálogo de retroalimentación -->
      <div id="retroalimentacion-dialogo" style="display: none">
        <p id="retroalimentacion-respuesta"></p>
      </div>
    </div>
  </body>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Selecciona todos los formularios de retroalimentación
      document.querySelectorAll(".retro-form").forEach((form) => {
        form.addEventListener("submit", function (event) {
          event.preventDefault(); // Previene la recarga de la página

          const formData = new FormData(form);

          // Realizar la solicitud POST con Fetch API
          fetch("{% url 'crear-retro' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
            },
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              // Mostrar la respuesta en un cuadro de diálogo
              const respuestaContainer = document.getElementById(
                "retroalimentacion-respuesta"
              );
              const dialogo = document.getElementById(
                "retroalimentacion-dialogo"
              );
              if (data.error) {
                respuestaContainer.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
              } else {
                respuestaContainer.innerHTML = `<p>${data.output}</p>`;
              }
              dialogo.style.display = "block";
            })
            .catch((error) => {
              console.error("Error:", error);
              document.getElementById(
                "retroalimentacion-respuesta"
              ).innerHTML = `<p style="color: red;">Ocurrió un error al procesar la retroalimentación.</p>`;
            });
        });
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
    const temas = {{ temas| safe }};
    const erroresPorTema = {{ errores_por_tema| safe }};

    var ctx = document.getElementById('pie-chart').getContext('2d');
    var myPieChart = new Chart(ctx, {
      type: 'polarArea',
      data: {
        labels: temas,
        datasets: [{
          data: erroresPorTema,
          backgroundColor: [
            'rgb(255, 99, 132)',
            'rgb(75, 192, 192)',
            'rgb(255, 205, 86)',
            'rgb(201, 203, 207)',
            'rgb(54, 162, 235)'],
          hoverBackgroundColor: 'rgb(240, 37, 0)',
        }],
      },
      options: {
        responsive: true,
      }
    });
        });
  </script>

  <script type="text/javascript">
    // Initialize the echarts instance based on the prepared dom
    var myChart = echarts.init(document.getElementById("egraphs"));

    // Specify the configuration items and data for the chart
    var option = {
      title: {
        text: "Barra",
      },
      tooltip: {},
      legend: {
        data: ["sales"],
      },
      xAxis: {
        data: ["Shirts", "Cardigans", "Chiffons", "Pants", "Heels", "Socks"],
      },
      yAxis: {},
      series: [
        {
          name: "sales",
          type: "bar",
          data: [5, 20, 36, 10, 10, 20],
        },
      ],
    };

    // Display the chart using the configuration items and data just specified.
    myChart.setOption(option);
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
        async function cargarComentario() {
            try {
                // Obtiene el ID del cuestionario desde el contexto de Django
                const cuestionarioId = {{ cuestionario.id| safe }};
                console.log(cuestionarioId)
                
                // Realiza el fetch a la vista Django para obtener el comentario
                const response = await fetch("{% url 'obtener-comentario' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({ cuestionario_id: cuestionarioId })
                });

                // Verifica si la respuesta es exitosa
                if (!response.ok) {
                    throw new Error("Error en la solicitud");
                }

                // Convierte la respuesta a JSON
                const data = await response.json();

                // Selecciona el div y muestra los datos obtenidos
                const infoDiv = document.getElementById('comentario-openai');
                
                if (data.output) {
                  // Aplica la función que convierte los asteriscos en negrita
                  let formattedText = formatTextToBold(data.output);
  
                  // Inserta el texto formateado en el div
                  infoDiv.innerHTML = `
                      <h2>Comentario del Cuestionario</h2>
                      <p>${formattedText}</p>
                  `;
                } else if (data.error) {
                    infoDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                }
                
            } catch (error) {
                console.error("Ocurrió un error al obtener los datos:", error);
                document.getElementById('comentario-openai').textContent = "Error al cargar los datos.";
            }
        }

        function formatTextToBold(text) {
          return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      }

        // Llama a la función para cargar los datos
        cargarComentario();
    });
</script>


</html>
